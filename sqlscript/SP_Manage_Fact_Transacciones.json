{
	"name": "SP_Manage_Fact_Transacciones",
	"properties": {
		"content": {
			"query": "\n\n\n\n --Extraer Fechas de PDF - Todas las entidades de cliente\n\n    Select \n        FechaTransaccion = Case WHEN TipoProducto = 'Cuenta Ahorros' then convert(date,right('0'+FechaTransaccion + '/' + substring(Fecha,0,5), 10), 103)\n                                WHEN TipoProducto = 'Fiducuenta' then convert(date,FechaTransaccion)\n                                WHEN TipoProducto = 'Tarjeta Credito' then convert(date,FechaTransaccion, 103)\n                            END,\n        DescripcionTransaccion,\n        ValorTransaccion,\n        ValorUnidades,\n        TasaPactada,\n        TasaFacturada,\n        CargosYAbonos,\n        SaldoADiferir,\n        Cuotas,\n        email,\n        TipoProducto,\n        NumeroProducto\n    into #Data_Transacciones\n    FROM \n        (   \n            SELECT \n                Fecha = Fecha,\n                FechaTransaccion,\n                DescripcionTransaccion,\n                ValorTransaccion,\n                ValorUnidades,\n                TasaPactada,\n                TasaFacturada,\n                CargosYAbonos,\n                SaldoADiferir,\n                Cuotas,\n                email,\n                TipoProducto,\n                NumeroProducto\n            FROM\n            (\n                SELECT                \n                    mt.FechaTransaccion,\n                    mt.DescripcionTransaccion,              \n                    ValorTransaccion = mt.ValorTransaccion,\n                    ValorUnidades = null,                    \n                    TasaPactada = null,\n                    TasaFacturada = null,\n                    CargosYAbonos = null,\n                    SaldoADiferir = null,\n                    Cuotas = null,\n                    email,\n                    mt.TipoProducto,\n                    mt.NumeroProducto,\n                    ss.value AS Fecha\n                FROM \n                    stage.CuentaAhorros_Transacciones mt\n                CROSS APPLY STRING_SPLIT(mt.pdfname, '_') ss\n                ) Dat\n            Where LEN(dat.Fecha) = 6\n        \n            UNION ALL\n            SELECT\n                Fecha = null,\n                mt.FechaTransaccion,\n                DescripcionTransaccion= Descripcion,\n                ValorTransaccion = mt.ValorPesos,\n                ValorUnidades = mt.ValorUnidades,\n                TasaPactada = null,\n                TasaFacturada = null,\n                CargosYAbonos = null,\n                SaldoADiferir = null,\n                Cuotas = null,\n                email,\n                mt.TipoProducto,\n                mt.NumeroProducto                \n            FROM\n                stage.FondoInversion_Transacciones mt            \n\n            UNION ALL\n            SELECT \n                Fecha = null,\n                mt.FechaTransaccion,\n                DescripcionTransaccion,\n                ValorTransaccion = mt.CostoTransaccion,\n                ValorUnidades = null,\n                TasaPactada = mt.TasaPactada,\n                TasaFacturada = mt.TasaFacturada,\n                CargosYAbonos = mt.CargosYAbonos,\n                SaldoADiferir = mt.SaldoAdiferir,\n                Cuotas = mt.Cuotas,\n                email,\n                mt.TipoProducto,\n                mt.NumeroProducto\n            FROM \n                stage.TarjetaCredito_Transacciones mt\n        ) DataTransacciones \n\n\n    --Obtener datos Cruzando con DImensiones\n\n    select \n        --tr.FechaTransaccion, \n        tr.DescripcionTransaccion,\n        tr.ValorTransaccion,\n        tr.ValorUnidades,\n        tr.TasaPactada,\n        tr.TasaFacturada,\n        tr.CargosYAbonos,\n        tr.SaldoADiferir,\n        tr.Cuotas,\n        tie.Key_Date,\n        --cli.[user],\n        cli.Cliente_Key,\n        --prd.TipoProducto,\n        --prd.NumeroProducto,\n        prd.Producto_Key\n    into #DataFinalModelo    \n    FROM \n        #Data_Transacciones tr\n    INNER JOIN \n        modelo_transacciones.Dim_Tiempo tie ON (tie.[Date] = tr.FechaTransaccion)\n    INNER JOIN \n        modelo_transacciones.cliente cli ON (cli.[user] = tr.email and cli.validohasta is NULL)\n    INNER JOIN \n        modelo_transacciones.Productos prd ON (prd.TipoProducto  = tr.TipoProducto and prd.NumeroProducto = tr.NumeroProducto and prd.validohasta is NULL)\n\n\n\nselect * from modelo_transacciones.cliente\nselect * from modelo_transacciones.Productos\n\n exec modelo_transacciones.SP_Manage_Dim_Producto\n exec modelo_transacciones.SP_Manage_Dim_Cliente\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "sqlpoolproyectomaestria",
				"poolName": "sqlpoolproyectomaestria"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}