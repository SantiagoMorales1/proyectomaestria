{
	"name": "SP_Manage_Dim_Cliente",
	"properties": {
		"content": {
			"query": "\n\n-- Procesamiento informacion clientes\n\n    --Extraer Fechas de PDF - Todas las entidades de cliente\n\n    IF OBJECT_ID(N'tempdb..#Data_Fechas') IS NOT NULL\n    BEGIN\n        DROP TABLE #Customer\n    END\n\n    Select \n        File_name, \n        Fecha = convert(date,Fecha+'01')\n    into #Data_Fechas    \n    FROM \n        (\n            SELECT \n                mt.File_name,\n                ss.value AS Fecha\n            FROM \n                stage.CuentaAhorros_Cliente mt\n            CROSS APPLY STRING_SPLIT(mt.File_name, '_') ss\n            UNION ALL\n            SELECT \n                mt.File_name,\n                ss.value AS Fecha\n            FROM \n                stage.FondoInversion_Cliente mt\n            CROSS APPLY STRING_SPLIT(mt.File_name, '_') ss\n            UNION ALL\n            SELECT \n                mt.File_name,\n                ss.value AS Fecha\n            FROM \n                stage.TarjetaCredito_Cliente mt\n            CROSS APPLY STRING_SPLIT(mt.File_name, '_') ss\n        ) fechas\n    WHERE LEN(Fecha) = 6\n\n\n    --Consultar informacion de clientes\n\n    IF OBJECT_ID(N'tempdb..#Raw_Clientes') IS NOT NULL\n    BEGIN\n        DROP TABLE #Raw_Clientes\n    END\n\n    select *, ROW_NUMBER ()  OVER ( PARTITION BY Email order by Fecha desc ) Incremental\n    into #Raw_Clientes\n    from\n    (\n        Select \n            cli.[Nombre]\n            ,cli.[Email]\n            ,cli.[Direccion]\n            ,cli.[Ciudad_1]\n            ,cli.[Ciudad_2]\n            ,cli.[File_name]  \n            ,fec.Fecha\n            --,ROW_NUMBER ()  OVER ( PARTITION BY Email order by fec.Fecha desc ) Incremental\n        --into \n        --    #Raw_Clientes\n        from \n        (\n            select \n                [Nombre]\n                ,[Email]\n                ,[Direccion]\n                ,[Ciudad_1]\n                ,[Ciudad_2]\n                ,[File_name]           \n            from stage.CuentaAhorros_Cliente\n            UNION ALL\n            select \n                [Nombre]\n                ,[Email]\n                ,[Direccion]\n                ,[Ciudad_1]\n                ,[Ciudad_2]\n                ,[File_name] \n            from stage.FondoInversion_Cliente\n            UNION ALL\n            select \n                [Nombre]\n                ,[Email]\n                ,[Direccion]\n                ,[Ciudad_1]\n                ,[Ciudad_2]\n                ,[File_name]\n            from stage.TarjetaCredito_Cliente\n        ) cli\n        INNER JOIN #Data_Fechas fec on (fec.File_name = cli.File_name)\n        UNION ALL\n            select 'andres', 'adreacorreo@hotmail.com', 'clle flasa 123', 'boyaca', 'boyaca', 'file123.pdf', '2023-05-06' \n            UNION ALL\n            select 'pablo', 'pablocorreo@hotmail.com', 'clle flasa 123', 'boyaca', 'boyaca', 'file123.pdf', '2023-05-06' \n            UNION ALL\n            select 'andres', 'adreacorreo@hotmail.com', 'clle flasa 123', 'boyaca', 'boyaca', 'file123.pdf', '2023-05-06' \n            UNION ALL\n            select 'andres uppda', 'adreacorreo@hotmail.com', 'clle flasa 123', 'boyaca', 'boyaca', 'file123.pdf', '2023-05-07' \n    ) dat2\n\n\n    -- Insertar data si No existe\n\n    insert into modelo_transacciones.Cliente (Nombre, [User], Direccion, Ciudad, Departamento, Fecha_Insert, ValidoDesde, ValidoHasta)\n    SELECT   \n        [Nombre]\n        ,[Email]\n        ,[Direccion]\n        ,[Ciudad_1]\n        ,[Ciudad_2]        \n        ,GETDATE()\n        ,convert(date,GETDATE())\n        ,null\n    FROM \n        #Raw_Clientes raw\n    where \n        raw.Incremental = 1 AND\n        not exists (select top 1 1 from modelo_transacciones.Cliente cli where cli.[User] = raw.[Email])\n\n    --Actualizar si existe las fechas de los registors vigentes anteriores\n\n    UPDATE \n        cli\n    SET \n        cli.ValidoHasta = getdate()\n    FROM \n        modelo_transacciones.Cliente cli\n    INNER JOIN \n        #Raw_Clientes raw\n        on \n            (cli.[User] = raw.[Email])\n     where \n        exists (select top 1 1 from modelo_transacciones.Cliente cli where cli.[User] = raw.[Email])\n        and raw.Incremental = 1\n        and cli.validoHasta  is null\n        and (cli.[Nombre] <> raw.[Nombre] or cli.[Direccion] <> raw.[Direccion] or cli.[Ciudad] <> raw.Ciudad_1 or cli.[Departamento] <> raw.Ciudad_2)\n\n\n    -- insertar nuevo registro de cambio\n\n    insert into modelo_transacciones.Cliente (Nombre, [User], Direccion, Ciudad, Departamento, Fecha_Insert, ValidoDesde, ValidoHasta)\n    SELECT   \n        raw.[Nombre]\n        ,raw.[Email]\n        ,raw.[Direccion]\n        ,raw.[Ciudad_1]\n        ,raw.[Ciudad_2]        \n        ,DATEADD(HOUR, -5, GETUTCDATE())\n        ,convert(date,DATEADD(HOUR, -5, GETUTCDATE()))\n        ,null\n    FROM\n        modelo_transacciones.Cliente cli\n    INNER JOIN\n        #Raw_Clientes raw\n        on \n            (cli.[User] = raw.[Email])\n    where\n        exists (select top 1 1 from modelo_transacciones.Cliente cli where cli.[User] = raw.[Email])\n        and raw.Incremental = 1\n        and (cli.[Nombre] <> raw.[Nombre] or cli.[Direccion] <> raw.[Direccion] or cli.[Ciudad] <> raw.Ciudad_1 or cli.[Departamento] <> raw.Ciudad_2)\n\n\n\n\nselect * from modelo_transacciones.Cliente\n\n\n\n\n\n",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "sqlpoolproyectomaestria",
				"poolName": "sqlpoolproyectomaestria"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}