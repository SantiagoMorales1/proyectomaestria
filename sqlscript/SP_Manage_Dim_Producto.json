{
	"name": "SP_Manage_Dim_Producto",
	"properties": {
		"content": {
			"query": "-- Procesamiento informacion productos\n\n    --Extraer Fechas de PDF - Todas las entidades de cliente\n\n    IF OBJECT_ID(N'tempdb..#Data_Fechas') IS NOT NULL\n    BEGIN\n        DROP TABLE #Data_Fechas\n    END\n\n    Select \n        File_name, \n        Fecha = convert(date,Fecha+'01')\n    into #Data_Fechas    \n    FROM \n        (\n            SELECT \n                mt.File_name,\n                ss.value AS Fecha            \n            FROM    \n                stage.CuentaAhorros_Producto mt\n            CROSS APPLY STRING_SPLIT(mt.File_name, '_') ss\n            UNION ALL\n            SELECT \n                mt.File_name,\n                ss.value AS Fecha\n            FROM \n                stage.FondoInversion_Producto mt\n            CROSS APPLY STRING_SPLIT(mt.File_name, '_') ss\n            UNION ALL\n            SELECT \n                mt.File_name,\n                ss.value AS Fecha\n            FROM \n                stage.TarjetaCredito_Producto mt\n            CROSS APPLY STRING_SPLIT(mt.File_name, '_') ss\n        ) fechas\n    WHERE LEN(Fecha) = 6\n\n\n    --Consultar informacion de productos\n\n    IF OBJECT_ID(N'tempdb..#Raw_Productos') IS NOT NULL\n    BEGIN\n        DROP TABLE #Raw_Productos\n    END\n    \n    SELECT         \n        TipoProducto,\n        NumeroProducto,\n        Sucursal,\n        Desde,\n        Hasta,\n        ValorUnidad,\n        Rentabilidad,\n        Comision,\n        TasaInteresMVCompra1Mes,\n        TasaInteresMVCompra2MesOMas,\n        TasaInteresMVImpuestos,\n        TasaInteresMVAvances,\n        TasaInteresMVMora,\n        TasaInteresEACompra1Mes,\n        TasaInteresEACompra2MesOMas,\n        TasaInteresEAImpuestos,\n        TasaInteresEAAvances,\n        TasaInteresEAMora,\n        File_name,\n        Fecha,\n        ROW_NUMBER ()  OVER ( PARTITION BY TipoProducto order by Fecha desc ) Incremental\n    into \n        #Raw_Productos\n    from\n    (        \n        Select \n            prd.TipoProducto,\n            prd.NumeroProducto,\n            prd.Sucursal,\n            prd.Desde,\n            prd.Hasta,\n            prd.ValorUnidad,\n            prd.Rentabilidad,\n            prd.Comision,\n            prd.TasaInteresMVCompra1Mes,\n            prd.TasaInteresMVCompra2MesOMas,\n            prd.TasaInteresMVImpuestos,\n            prd.TasaInteresMVAvances,\n            prd.TasaInteresMVMora,\n            prd.TasaInteresEACompra1Mes,\n            prd.TasaInteresEACompra2MesOMas,\n            prd.TasaInteresEAImpuestos,\n            prd.TasaInteresEAAvances,\n            prd.TasaInteresEAMora,\n            prd.File_name,\n            fec.Fecha\n        from \n        (\n            select\n                TipoProducto = TipoProducto,\n                NumeroProducto = NumeroProducto,\n                Sucursal = sucursal,\n                Desde = null,\n                Hasta = null,\n                ValorUnidad = null,\n                Rentabilidad = null,\n                Comision = null,\n                TasaInteresMVCompra1Mes = null,\n                TasaInteresMVCompra2MesOMas = null,\n                TasaInteresMVImpuestos = null, \n                TasaInteresMVAvances = null,\n                TasaInteresMVMora = null,\n                TasaInteresEACompra1Mes = null,\n                TasaInteresEACompra2MesOMas = null,\n                TasaInteresEAImpuestos = null,\n                TasaInteresEAAvances = null,\n                TasaInteresEAMora = null,\n                File_name = File_name\n            from stage.CuentaAhorros_Producto\n            UNION ALL\n            select \n                TipoProducto = TipoProducto,\n                NumeroProducto = NumeroProducto,\n                Sucursal = null,\n                Desde = Desde,\n                Hasta = Hasta,\n                ValorUnidad = ValorUnidad,\n                Rentabilidad = Rentabilidad,\n                Comision = Comision,\n                TasaInteresMVCompra1Mes = null,\n                TasaInteresMVCompra2MesOMas = null,\n                TasaInteresMVImpuestos = null, \n                TasaInteresMVAvances = null,\n                TasaInteresMVMora = null,\n                TasaInteresEACompra1Mes = null,\n                TasaInteresEACompra2MesOMas = null,\n                TasaInteresEAImpuestos = null,\n                TasaInteresEAAvances = null,\n                TasaInteresEAMora = null,\n                File_name = File_name\n            from stage.FondoInversion_Producto\n            UNION ALL\n            select \n                TipoProducto = TipoProducto,\n                NumeroProducto = NumeroTarjeta,\n                Sucursal = null,\n                Desde = null,\n                Hasta = null,\n                ValorUnidad = null,\n                Rentabilidad = null,\n                Comision = null,\n                TasaInteresMVCompra1Mes = TasaInteresMVCompra1Mes,\n                TasaInteresMVCompra2MesOMas = TasaInteresMVCompra2MesOMas,\n                TasaInteresMVImpuestos = TasaInteresMVImpuestos, \n                TasaInteresMVAvances = TasaInteresMVAvances,\n                TasaInteresMVMora = TasaInteresMVMora,\n                TasaInteresEACompra1Mes = TasaInteresEACompra1Mes,\n                TasaInteresEACompra2MesOMas =TasaInteresEACompra2MesOMas,\n                TasaInteresEAImpuestos = TasaInteresEAImpuestos,\n                TasaInteresEAAvances = TasaInteresEAAvances,\n                TasaInteresEAMora = TasaInteresEAMora,\n                File_name = File_name\n            from stage.TarjetaCredito_Producto\n        ) prd\n        INNER JOIN #Data_Fechas fec on (fec.File_name = prd.File_name)\n    ) dat2\n\n\n    -- Insertar data si No existe\n\n    insert into modelo_transacciones.Cliente (TipoProducto, NumeroProducto, Sucursal, Desde, Hasta, ValorUnidad, Rentabilidad, Comision, TasaInteresMVCompra1Mes,\n            TasaInteresMVCompra2MesOMas, TasaInteresMVImpuestos, TasaInteresMVAvances, TasaInteresMVMora, TasaInteresEACompra1Mes, TasaInteresEACompra2MesOMas,\n            TasaInteresEAImpuestos, TasaInteresEAAvances, TasaInteresEAMora, Fecha_Insert, ValidoDesde, ValidoHasta)\n    SELECT   \n        TipoProducto,\n        NumeroProducto,\n        Sucursal,\n        Desde,\n        Hasta,\n        ValorUnidad,\n        Rentabilidad,\n        Comision,\n        TasaInteresMVCompra1Mes,\n        TasaInteresMVCompra2MesOMas,\n        TasaInteresMVImpuestos,\n        TasaInteresMVAvances,\n        TasaInteresMVMora,\n        TasaInteresEACompra1Mes,\n        TasaInteresEACompra2MesOMas,\n        TasaInteresEAImpuestos,\n        TasaInteresEAAvances,\n        TasaInteresEAMora,      \n        DATEADD(HOUR, -5, GETUTCDATE()),\n        DATEADD(HOUR, -5, GETUTCDATE()),\n        null\n    FROM \n        #Raw_Productos raw\n    where \n        raw.Incremental = 1 AND\n        not exists (select top 1 1 from modelo_transacciones.Productos prd where prd.TipoProducto = raw.TipoProducto)",
			"metadata": {
				"language": "sql"
			},
			"currentConnection": {
				"databaseName": "sqlpoolproyectomaestria",
				"poolName": "sqlpoolproyectomaestria"
			},
			"resultLimit": 5000
		},
		"type": "SqlQuery"
	}
}